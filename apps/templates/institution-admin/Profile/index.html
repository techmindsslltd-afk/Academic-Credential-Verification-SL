{% extends "layouts/base.html" %}

{% block title %} Institution Profile {% endblock %} 

{% block content %}
{% load static %}   
	  
  <section class="content-section active" id="section-inst-profile">
    <div class="section-header">
      <div>
        <h1 class="section-title">Institution Profile</h1>
        <p class="section-subtitle">Manage your profile and institution information</p>
      </div>
    </div>

    <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 1.5rem; margin-top: 1.5rem;">
      <!-- Profile Card -->
      <div class="data-table-card">
        <div style="text-align: center; padding: 2rem 1.5rem;">
          <div style="position: relative; display: inline-block; margin-bottom: 1rem;">
            {% if user.avatar %}
              <img src="{{ user.avatar.url }}" alt="{{ user.full_name }}" style="width: 120px; height: 120px; border-radius: 50%; object-fit: cover; border: 4px solid var(--accent-primary);">
            {% else %}
              <div style="width: 120px; height: 120px; border-radius: 50%; background: var(--accent-primary); display: flex; align-items: center; justify-content: center; color: white; font-size: 2.5rem; font-weight: 600; border: 4px solid var(--accent-primary); margin: 0 auto;">
                {{ user.first_name|first|upper }}{{ user.last_name|first|upper }}
              </div>
            {% endif %}
            <label for="avatar-upload" style="position: absolute; bottom: 0; right: 0; background: var(--accent-primary); color: white; width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; border: 3px solid var(--bg-card); box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
              </svg>
            </label>
            <input type="file" id="avatar-upload" accept="image/*" style="display: none;" onchange="handleAvatarUpload(event)">
          </div>
          <h2 style="margin: 0.5rem 0 0.25rem 0; font-size: 1.5rem; font-weight: 600;">{{ user.full_name }}</h2>
          <p style="margin: 0; color: var(--text-muted); font-size: 0.875rem;">{{ user.get_role_display }}</p>
          {% if admin_profile.position %}
          <p style="margin: 0.5rem 0 0 0; color: var(--text-primary); font-size: 0.875rem; font-weight: 500;">{{ admin_profile.position }}</p>
          {% endif %}
          {% if institution %}
          <p style="margin: 0.5rem 0 0 0; color: var(--text-muted); font-size: 0.875rem;">{{ institution.name }}</p>
          {% endif %}
        </div>
      </div>

      <!-- Profile Forms -->
      <div style="display: flex; flex-direction: column; gap: 1.5rem;">
        <!-- Personal Information -->
        <div class="data-table-card">
          <div style="padding: 1.5rem; border-bottom: 1px solid var(--border-color);">
            <h3 style="margin: 0; font-size: 1.125rem; font-weight: 600;">Personal Information</h3>
            <p style="margin: 0.5rem 0 0 0; color: var(--text-muted); font-size: 0.875rem;">Update your personal details</p>
          </div>
          <form id="personal-info-form" style="padding: 1.5rem;">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
              <div class="form-group">
                <label class="form-label">First Name <span style="color: var(--error);">*</span></label>
                <input type="text" id="first-name" name="first_name" class="input" value="{{ user.first_name }}" required>
              </div>
              <div class="form-group">
                <label class="form-label">Last Name <span style="color: var(--error);">*</span></label>
                <input type="text" id="last-name" name="last_name" class="input" value="{{ user.last_name }}" required>
              </div>
            </div>
            <div class="form-group" style="margin-bottom: 1rem;">
              <label class="form-label">Email <span style="color: var(--error);">*</span></label>
              <input type="email" id="email" name="email" class="input" value="{{ user.email }}" required>
            </div>
            <div class="form-group" style="margin-bottom: 1rem;">
              <label class="form-label">Phone</label>
              <input type="text" id="phone" name="phone" class="input" value="{{ user.phone }}">
            </div>
            <div style="display: flex; justify-content: flex-end; gap: 0.75rem; margin-top: 1.5rem;">
              <button type="button" class="btn btn-outline" onclick="resetPersonalForm()">Reset</button>
              <button type="submit" class="btn btn-primary" id="personal-save-btn">
                <span class="btn-text">Save Changes</span>
                <span class="btn-spinner" style="display: none;">
                  <span class="spinner" style="width: 16px; height: 16px; border-width: 2px;"></span>
                </span>
              </button>
            </div>
          </form>
        </div>

        <!-- Professional Information -->
        <div class="data-table-card">
          <div style="padding: 1.5rem; border-bottom: 1px solid var(--border-color);">
            <h3 style="margin: 0; font-size: 1.125rem; font-weight: 600;">Professional Information</h3>
            <p style="margin: 0.5rem 0 0 0; color: var(--text-muted); font-size: 0.875rem;">Update your professional details</p>
          </div>
          <form id="professional-info-form" style="padding: 1.5rem;">
            <div class="form-group" style="margin-bottom: 1rem;">
              <label class="form-label">Position</label>
              <input type="text" id="position" name="position" class="input" value="{{ admin_profile.position }}" placeholder="e.g., Registrar, Academic Dean">
            </div>
            <div class="form-group" style="margin-bottom: 1rem;">
              <label class="form-label">Department</label>
              <input type="text" id="department" name="department" class="input" value="{{ admin_profile.department }}" placeholder="e.g., Academic Affairs">
            </div>
            <div class="form-group" style="margin-bottom: 1rem;">
              <label class="form-label">Employee ID</label>
              <input type="text" id="employee-id" name="employee_id" class="input" value="{{ admin_profile.employee_id }}" placeholder="e.g., EMP001">
            </div>
            <div style="display: flex; justify-content: flex-end; gap: 0.75rem; margin-top: 1.5rem;">
              <button type="button" class="btn btn-outline" onclick="resetProfessionalForm()">Reset</button>
              <button type="submit" class="btn btn-primary" id="professional-save-btn">
                <span class="btn-text">Save Changes</span>
                <span class="btn-spinner" style="display: none;">
                  <span class="spinner" style="width: 16px; height: 16px; border-width: 2px;"></span>
                </span>
              </button>
            </div>
          </form>
        </div>

        <!-- Institution Information (Read-only) -->
        {% if institution %}
        <div class="data-table-card">
          <div style="padding: 1.5rem; border-bottom: 1px solid var(--border-color);">
            <h3 style="margin: 0; font-size: 1.125rem; font-weight: 600;">Institution Information</h3>
            <p style="margin: 0.5rem 0 0 0; color: var(--text-muted); font-size: 0.875rem;">Your institution details</p>
          </div>
          <div style="padding: 1.5rem;">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
              <div>
                <label style="display: block; font-size: 0.75rem; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.5rem;">Institution Name</label>
                <p style="margin: 0; font-size: 0.875rem; color: var(--text-primary);">{{ institution.name }}</p>
              </div>
              <div>
                <label style="display: block; font-size: 0.75rem; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.5rem;">Institution Type</label>
                <p style="margin: 0; font-size: 0.875rem; color: var(--text-primary);">{{ institution.get_institution_type_display }}</p>
              </div>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
              <div>
                <label style="display: block; font-size: 0.75rem; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.5rem;">Country</label>
                <p style="margin: 0; font-size: 0.875rem; color: var(--text-primary);">{{ institution.country }}</p>
              </div>
              <div>
                <label style="display: block; font-size: 0.75rem; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.5rem;">City</label>
                <p style="margin: 0; font-size: 0.875rem; color: var(--text-primary);">{{ institution.city|default:"â€”" }}</p>
              </div>
            </div>
            {% if institution.email %}
            <div style="margin-bottom: 1rem;">
              <label style="display: block; font-size: 0.75rem; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.5rem;">Institution Email</label>
              <p style="margin: 0; font-size: 0.875rem; color: var(--text-primary);">{{ institution.email }}</p>
            </div>
            {% endif %}
            {% if institution.website %}
            <div style="margin-bottom: 1rem;">
              <label style="display: block; font-size: 0.75rem; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.5rem;">Website</label>
              <p style="margin: 0; font-size: 0.875rem; color: var(--text-primary);">
                <a href="{{ institution.website }}" target="_blank" style="color: var(--accent-primary); text-decoration: none;">{{ institution.website }}</a>
              </p>
            </div>
            {% endif %}
            <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border-color);">
              <span class="status-badge {% if institution.is_verified %}success{% else %}warning{% endif %}" style="margin-right: 0.5rem;">
                {% if institution.is_verified %}Verified{% else %}Not Verified{% endif %}
              </span>
              <span class="status-badge {% if institution.is_active %}success{% else %}error{% endif %}">
                {% if institution.is_active %}Active{% else %}Inactive{% endif %}
              </span>
            </div>
          </div>
        </div>
        {% endif %}

        <!-- Change Password -->
        <div class="data-table-card">
          <div style="padding: 1.5rem; border-bottom: 1px solid var(--border-color);">
            <h3 style="margin: 0; font-size: 1.125rem; font-weight: 600;">Change Password</h3>
            <p style="margin: 0.5rem 0 0 0; color: var(--text-muted); font-size: 0.875rem;">Update your account password</p>
          </div>
          <form id="password-form" style="padding: 1.5rem;">
            <div class="form-group" style="margin-bottom: 1rem;">
              <label class="form-label">Current Password <span style="color: var(--error);">*</span></label>
              <input type="password" id="old-password" name="old_password" class="input" required>
            </div>
            <div class="form-group" style="margin-bottom: 1rem;">
              <label class="form-label">New Password <span style="color: var(--error);">*</span></label>
              <input type="password" id="new-password" name="new_password" class="input" required minlength="8">
              <small style="color: var(--text-muted); font-size: 0.75rem; margin-top: 0.25rem; display: block;">Password must be at least 8 characters long</small>
            </div>
            <div class="form-group" style="margin-bottom: 1rem;">
              <label class="form-label">Confirm New Password <span style="color: var(--error);">*</span></label>
              <input type="password" id="confirm-password" name="confirm_password" class="input" required minlength="8">
            </div>
            <div style="display: flex; justify-content: flex-end; gap: 0.75rem; margin-top: 1.5rem;">
              <button type="button" class="btn btn-outline" onclick="resetPasswordForm()">Reset</button>
              <button type="submit" class="btn btn-primary" id="password-save-btn">
                <span class="btn-text">Change Password</span>
                <span class="btn-spinner" style="display: none;">
                  <span class="spinner" style="width: 16px; height: 16px; border-width: 2px;"></span>
                </span>
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </section>

  <script>
    // Store original values for reset
    const originalPersonalData = {
      first_name: '{{ user.first_name|escapejs }}',
      last_name: '{{ user.last_name|escapejs }}',
      email: '{{ user.email|escapejs }}',
      phone: '{{ user.phone|escapejs }}',
    };
    
    const originalProfessionalData = {
      position: '{{ admin_profile.position|escapejs }}',
      department: '{{ admin_profile.department|escapejs }}',
      employee_id: '{{ admin_profile.employee_id|escapejs }}',
    };

    // Personal Information Form
    document.getElementById('personal-info-form').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const form = e.target;
      const formData = new FormData(form);
      const data = Object.fromEntries(formData.entries());
      
      const submitBtn = document.getElementById('personal-save-btn');
      const btnText = submitBtn.querySelector('.btn-text');
      const btnSpinner = submitBtn.querySelector('.btn-spinner');
      
      btnText.style.display = 'none';
      btnSpinner.style.display = 'inline-block';
      submitBtn.disabled = true;
      
      try {
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
                         document.cookie.split(';').find(c => c.trim().startsWith('csrftoken='))?.split('=')[1];
        
        const response = await fetch('/institution-admin/profile/update/', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken,
          },
          credentials: 'include',
          body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (response.ok && result.success) {
          Swal.fire({
            icon: 'success',
            title: 'Success!',
            text: result.message || 'Personal information updated successfully',
            timer: 2000,
            showConfirmButton: false,
            toast: true,
            position: 'top-end'
          });
          
          // Update original data
          Object.assign(originalPersonalData, data);
          
          // Update displayed name if changed
          if (result.user && result.user.full_name) {
            // Update any displayed name elements
            const nameElements = document.querySelectorAll('h2');
            if (nameElements.length > 0) {
              nameElements[0].textContent = result.user.full_name;
            }
          }
        } else {
          Swal.fire({
            icon: 'error',
            title: 'Error!',
            text: result.error || 'Failed to update personal information',
            confirmButtonText: 'OK'
          });
        }
      } catch (error) {
        console.error('Error updating personal information:', error);
        Swal.fire({
          icon: 'error',
          title: 'Error!',
          text: 'An error occurred while updating personal information',
          confirmButtonText: 'OK'
        });
      } finally {
        btnText.style.display = 'inline-block';
        btnSpinner.style.display = 'none';
        submitBtn.disabled = false;
      }
    });

    // Professional Information Form
    document.getElementById('professional-info-form').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const form = e.target;
      const formData = new FormData(form);
      const data = Object.fromEntries(formData.entries());
      
      const submitBtn = document.getElementById('professional-save-btn');
      const btnText = submitBtn.querySelector('.btn-text');
      const btnSpinner = submitBtn.querySelector('.btn-spinner');
      
      btnText.style.display = 'none';
      btnSpinner.style.display = 'inline-block';
      submitBtn.disabled = false;
      
      try {
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
                         document.cookie.split(';').find(c => c.trim().startsWith('csrftoken='))?.split('=')[1];
        
        const response = await fetch('/institution-admin/profile/update/', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken,
          },
          credentials: 'include',
          body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (response.ok && result.success) {
          Swal.fire({
            icon: 'success',
            title: 'Success!',
            text: result.message || 'Professional information updated successfully',
            timer: 2000,
            showConfirmButton: false,
            toast: true,
            position: 'top-end'
          });
          
          // Update original data
          Object.assign(originalProfessionalData, data);
        } else {
          Swal.fire({
            icon: 'error',
            title: 'Error!',
            text: result.error || 'Failed to update professional information',
            confirmButtonText: 'OK'
          });
        }
      } catch (error) {
        console.error('Error updating professional information:', error);
        Swal.fire({
          icon: 'error',
          title: 'Error!',
          text: 'An error occurred while updating professional information',
          confirmButtonText: 'OK'
        });
      } finally {
        btnText.style.display = 'inline-block';
        btnSpinner.style.display = 'none';
        submitBtn.disabled = false;
      }
    });

    // Password Form
    document.getElementById('password-form').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const form = e.target;
      const formData = new FormData(form);
      const data = Object.fromEntries(formData.entries());
      
      // Validate passwords match
      if (data.new_password !== data.confirm_password) {
        Swal.fire({
          icon: 'error',
          title: 'Error!',
          text: 'New passwords do not match',
          confirmButtonText: 'OK'
        });
        return;
      }
      
      const submitBtn = document.getElementById('password-save-btn');
      const btnText = submitBtn.querySelector('.btn-text');
      const btnSpinner = submitBtn.querySelector('.btn-spinner');
      
      btnText.style.display = 'none';
      btnSpinner.style.display = 'inline-block';
      submitBtn.disabled = true;
      
      try {
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
                         document.cookie.split(';').find(c => c.trim().startsWith('csrftoken='))?.split('=')[1];
        
        const response = await fetch('/institution-admin/profile/change-password/', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken,
          },
          credentials: 'include',
          body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (response.ok && result.success) {
          Swal.fire({
            icon: 'success',
            title: 'Success!',
            text: result.message || 'Password changed successfully',
            timer: 2000,
            showConfirmButton: false,
            toast: true,
            position: 'top-end'
          });
          
          // Clear form
          form.reset();
        } else {
          Swal.fire({
            icon: 'error',
            title: 'Error!',
            text: result.error || 'Failed to change password',
            confirmButtonText: 'OK'
          });
        }
      } catch (error) {
        console.error('Error changing password:', error);
        Swal.fire({
          icon: 'error',
          title: 'Error!',
          text: 'An error occurred while changing password',
          confirmButtonText: 'OK'
        });
      } finally {
        btnText.style.display = 'inline-block';
        btnSpinner.style.display = 'none';
        submitBtn.disabled = false;
      }
    });

    // Avatar Upload
    async function handleAvatarUpload(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      // Validate file type
      if (!file.type.startsWith('image/')) {
        Swal.fire({
          icon: 'error',
          title: 'Invalid File',
          text: 'Please select an image file',
          confirmButtonText: 'OK'
        });
        return;
      }
      
      // Validate file size (max 5MB)
      if (file.size > 5 * 1024 * 1024) {
        Swal.fire({
          icon: 'error',
          title: 'File Too Large',
          text: 'Image must be less than 5MB',
          confirmButtonText: 'OK'
        });
        return;
      }
      
      const formData = new FormData();
      formData.append('avatar', file);
      formData.append('first_name', document.getElementById('first-name').value);
      formData.append('last_name', document.getElementById('last-name').value);
      formData.append('email', document.getElementById('email').value);
      formData.append('phone', document.getElementById('phone').value);
      
      try {
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
                         document.cookie.split(';').find(c => c.trim().startsWith('csrftoken='))?.split('=')[1];
        
        const response = await fetch('/institution-admin/profile/update/', {
          method: 'POST',
          headers: {
            'X-CSRFToken': csrfToken,
          },
          credentials: 'include',
          body: formData
        });
        
        const result = await response.json();
        
        if (response.ok && result.success) {
          // Update avatar display
          if (result.user && result.user.avatar) {
            const avatarImg = document.querySelector('img[alt="{{ user.full_name|escapejs }}"]');
            if (avatarImg) {
              avatarImg.src = result.user.avatar + '?t=' + new Date().getTime();
            }
          } else {
            // Reload page to show new avatar
            window.location.reload();
          }
          
          Swal.fire({
            icon: 'success',
            title: 'Success!',
            text: 'Avatar updated successfully',
            timer: 2000,
            showConfirmButton: false,
            toast: true,
            position: 'top-end'
          });
        } else {
          Swal.fire({
            icon: 'error',
            title: 'Error!',
            text: result.error || 'Failed to update avatar',
            confirmButtonText: 'OK'
          });
        }
      } catch (error) {
        console.error('Error uploading avatar:', error);
        Swal.fire({
          icon: 'error',
          title: 'Error!',
          text: 'An error occurred while uploading avatar',
          confirmButtonText: 'OK'
        });
      }
    }

    // Reset Functions
    function resetPersonalForm() {
      document.getElementById('first-name').value = originalPersonalData.first_name;
      document.getElementById('last-name').value = originalPersonalData.last_name;
      document.getElementById('email').value = originalPersonalData.email;
      document.getElementById('phone').value = originalPersonalData.phone;
    }

    function resetProfessionalForm() {
      document.getElementById('position').value = originalProfessionalData.position;
      document.getElementById('department').value = originalProfessionalData.department;
      document.getElementById('employee-id').value = originalProfessionalData.employee_id;
    }

    function resetPasswordForm() {
      document.getElementById('password-form').reset();
    }
  </script>

  <style>
    .form-group {
      margin-bottom: 1rem;
    }
    
    .form-label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 500;
      font-size: 0.875rem;
      color: var(--text-primary);
    }
    
    @media (max-width: 768px) {
      section.content-section > div[style*="grid-template-columns"] {
        grid-template-columns: 1fr !important;
      }
    }
  </style>

{% endblock content %}
